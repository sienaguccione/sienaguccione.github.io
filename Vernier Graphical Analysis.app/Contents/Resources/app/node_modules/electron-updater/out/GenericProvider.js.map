{"version":3,"file":"GenericProvider.js","sourceRoot":"","sources":["../src/GenericProvider.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;AAAA,AAAO,AAAwB,AAAS,AAA4B,AAAM,AAAsB;;;;;;AAChG,AAAO,AAAE,AAAkB,AAAE,AAAoB,AAAE,AAAqB,AAAE,AAAmB,AAAE,AAAU,AAAE,AAAc,AAAE,AAAQ,AAA0B,AAAM,AAAQ;;;;;;AAC3K,AAAO,AAAE,AAAe,AAAE,AAAY,AAAE,AAAM,AAAY,AAE1D,AAAM;;;;MAAuB,AAAQ,AAAoB;AAIvD,gBAA6B,AAAmC,eAAE,AAA2B;AAC3F,AAAK,cAAC,AAAQ,AAAC;AADY,aAAa,gBAAb,AAAa,AAAsB;AAH/C,aAAO,UAAG,AAAU,wCAAC,AAAI,KAAC,AAAa,cAAC,AAAG,AAAC;AAC5C,aAAO,UAAG,AAAI,KAAC,AAAa,cAAC,AAAO,AAAC,AAAC,UAAC,AAAoB,kDAAC,AAAI,KAAC,AAAa,cAAC,AAAO,AAAC,AAAC,AAAC,WAAC,AAAqB,AAAE,AAIlI;AAAC;AAEK,AAAgB,oBAAtB,AAAK;;;;AACH,gBAAI,AAAkB;AACtB,kBAAM,AAAW,cAAG,AAAkB,gDAAC,AAAI,MAAC,AAAO,AAAC;AACpD,kBAAM,AAAU,aAAG,AAAc,4CAAC,AAAW,aAAE,AAAI,MAAC,AAAO,AAAC;AAC5D,AAAG,AAAC,iBAAC,IAAI,AAAa,gBAAG,AAAC,IAAI,AAAa,AAAE,iBAAE,AAAC;AAC9C,oBAAI,AAAC;AACH,AAAM,6BAAG,AAAe,AAAC,sDAAC,MAAM,AAAI,MAAC,AAAQ,SAAC,AAAO,QAAC,AAAI,MAAC,AAAoB,qBAAC,AAAU,AAAC,AAAC,AAAG,eAAE,AAAW,aAAE,AAAU,AAAC;AACzH,AAAK,AACP;AAAC,kBACD,AAAK,AAAC,OAAC,AAAC,AAAC,GAAC,AAAC;AACT,AAAE,AAAC,wBAAC,AAAC,AAAY,AAAS,8EAAI,AAAC,EAAC,AAAQ,SAAC,AAAU,eAAK,AAAG,AAAC,KAAC,AAAC;AAC5D,8BAAM,IAAI,AAAK,AAAC,8BAAwB,AAAW,6BAAkB,AAAC,EAAC,AAAK,SAAI,AAAC,EAAC,AAAO,OAAE,AAAC,AAC9F;AAAC,AACD,AAAI,2BAAC,AAAE,AAAC,IAAC,AAAC,EAAC,AAAI,SAAK,AAAc,AAAC,gBAAC,AAAC;AACnC,AAAE,AAAC,4BAAC,AAAa,gBAAG,AAAC,AAAC,GAAC,AAAC;AACtB,sCAAU,AAAO,QAAC,UAAC,AAAO,SAAE,AAAM,AAAE,AAAE;AACpC,oCAAI,AAAC;AACH,AAAU,+CAAC,AAAO,SAAE,AAAI,OAAG,AAAa,AAAC,AAC3C;AAAC,kCACD,AAAK,AAAC,OAAC,AAAC,AAAC,GAAC,AAAC;AACT,AAAM,2CAAC,AAAC,AAAC,AACX;AAAC,AACH;AAAC,AAAC,6BAPI;AAQN,AAAQ,AACV;AAAC,AACH;AAAC;AACD,0BAAM,AAAC,AACT;AAAC,AACH;AAAC;AAED,AAAE,AAAC,gBAAC,AAAmB,AAAE,AAAC,oDAAC,AAAC;AACzB,AAAc,uBAAC,AAAc,iBAAG,AAAU,WAAC,AAAI,AAClD;AAAC;AACD,AAAM,mBAAC,AAAM,AACf;;AAAC;AAED,AAAY,iBAAC,AAAsB;AACjC,AAAM,eAAC,AAAY,kDAAC,AAAU,YAAE,AAAI,KAAC,AAAO,AAAC,AAC/C;AAAC,AACF","sourcesContent":["import { GenericServerOptions, HttpError, HttpExecutor, UpdateInfo } from \"builder-util-runtime\"\nimport { getChannelFilename, getCustomChannelName, getDefaultChannelName, isUseOldMacProvider, newBaseUrl, newUrlFromBase, Provider, ResolvedUpdateFileInfo } from \"./main\"\nimport { parseUpdateInfo, resolveFiles } from \"./Provider\"\n\nexport class GenericProvider extends Provider<UpdateInfo> {\n  private readonly baseUrl = newBaseUrl(this.configuration.url)\n  private readonly channel = this.configuration.channel ? getCustomChannelName(this.configuration.channel) : getDefaultChannelName()\n\n  constructor(private readonly configuration: GenericServerOptions, executor: HttpExecutor<any>) {\n    super(executor)\n  }\n\n  async getLatestVersion(): Promise<UpdateInfo> {\n    let result: UpdateInfo\n    const channelFile = getChannelFilename(this.channel)\n    const channelUrl = newUrlFromBase(channelFile, this.baseUrl)\n    for (let attemptNumber = 0; ; attemptNumber++) {\n      try {\n        result = parseUpdateInfo((await this.executor.request(this.createRequestOptions(channelUrl)))!!, channelFile, channelUrl)\n        break\n      }\n      catch (e) {\n        if (e instanceof HttpError && e.response.statusCode === 404) {\n          throw new Error(`Cannot find channel \"${channelFile}\" update info: ${e.stack || e.message}`)\n        }\n        else if (e.code === \"ECONNREFUSED\") {\n          if (attemptNumber < 3) {\n            await new Promise((resolve, reject) => {\n              try {\n                setTimeout(resolve, 1000 * attemptNumber)\n              }\n              catch (e) {\n                reject(e)\n              }\n            })\n            continue\n          }\n        }\n        throw e\n      }\n    }\n\n    if (isUseOldMacProvider()) {\n      (result as any).releaseJsonUrl = channelUrl.href\n    }\n    return result\n  }\n\n  resolveFiles(updateInfo: UpdateInfo): Array<ResolvedUpdateFileInfo> {\n    return resolveFiles(updateInfo, this.baseUrl)\n  }\n}"]}
