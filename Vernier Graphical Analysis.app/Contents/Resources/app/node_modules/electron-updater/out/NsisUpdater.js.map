{"version":3,"file":"NsisUpdater.js","sourceRoot":"","sources":["../src/NsisUpdater.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;AACA,AAAO,AAAE,AAAmB,AAAE,AAAM,AAAsC;;;;;;AAC1E,AAAO,AAAE,AAAK,AAAE,AAAM,AAAe;;;;AACrC,AAAO,AAAK,AAAI,AAAM,AAAM;;AAC5B,AAAO,AAA6B;;;;AACpC,AAAO,AAAE,AAA8B,AAAE,AAAM,AAAyD;;;;;;AACxG,AAAO,AAAE,AAAiB,AAAE,AAAM,AAAQ;;;;;;AAC1C,AAAO,AAAE,AAAe,AAAE,AAAM,AAA0C;;;;;;AAC1E,AAAO,AAAE,AAAW,AAAE,AAAM,AAAe;;;;;;AAC3C,AAAO,AAAE,AAAQ,AAAE,AAAM,AAAY,AAErC,AAAM;;;;;;MAAmB,AAAQ,AAAW;AAC1C,gBAAY,AAAkC,SAAE,AAAS;AACvD,AAAK,cAAC,AAAO,SAAE,AAAG,AAAC,AACrB;AAAC;AAED,AAAgB;AACA,AAAgB,oBAAtB,AAAK,CAAkB,AAAsB,YAAE,AAAoC;;;;AAC3F,kBAAM,AAAQ,WAAG,AAAQ,8CAAC,CAAC,MAAM,AAAI,MAAC,AAAQ,AAAC,UAAC,AAAY,aAAC,AAAU,AAAC,aAAE,AAAK,AAAG;AAClF,kBAAM,AAAc,iBAAG,MAAM,AAAI,MAAC,AAAqB,AAAE;AACzD,kBAAM,AAAe;AACnB,AAAe,iCAAE,AAAI;AACrB,AAAO,yBAAE,AAAc;AACvB,AAAiB;AACjB,AAAM,wBAAE,AAAQ,SAAC,AAAI,KAAC,AAAM,AAC7B;AALwC;AAOzC,gBAAI,AAAW,cAAkB,AAAI,MAAC,AAAsB,uBAAC,AAAW;AAExE,gBAAI,AAAa,gBAAG,AAAI,MAAC,AAAsB,uBAAC,AAAiB,kBAAC,AAAU,YAAE,AAAQ,AAAC;AACvF,AAAE,AAAC,gBAAC,AAAa,iBAAI,AAAI,AAAC,MAAC,AAAC;AAC1B,AAAM,uBAAC,AAAW,eAAI,AAAI,AAAC,AAAC,OAAC,CAAC,AAAa,AAAC,AAAC,AAAC,iBAAC,CAAC,AAAa,eAAE,AAAW,AAAC,AAC7E;AAAC;AAED,wBAAW,AAAe,gBAAC,AAAe,iBAAE,AAAQ;AAA9C,AAAI,gFAA4C,AAAK,WAAE,AAAO,SAAE,AAAe,iBAAE,AAAkB,AAAE,AAAE;AAC3G,AAAa,oCAAG,AAAe;AAC/B,wBAAI,AAA2B;AAC/B,0BAAM,AAAI,MAAC,AAAY,aAAC,AAAQ,SAAC,AAAQ,SAAC,AAAG,IAAC,AAAI,MAAE,AAAa,eAAE,AAAe,AAAC;AACnF,AAA2B,kDAAG,MAAM,AAAI,MAAC,AAAe,gBAAC,AAAa,AAAC;AAEvE,0BAAM,AAAW,cAAG,AAAQ,SAAC,AAAW;AACxC,AAAE,AAAC,wBAAC,AAAW,eAAI,AAAI,AAAC,MAAC,AAAC;AACxB,AAAW,sCAAG,AAAI,MAAC,AAAI,KAAC,AAAO,AAAE,oBAAW,AAAU,WAAC,AAAO,UAAG,AAAI,MAAC,AAAO,QAAC,AAAW,YAAC,AAAI,AAAC,SAAI,AAAK,KAAE,AAAC;AAE3G,4BAAI,AAAc,iBAAG,AAAW,YAAC,AAAY,gBAAI,AAAI,QAAI,AAAW,YAAC,AAAU,cAAI,AAAI;AACvF,AAAE,AAAC,4BAAC,CAAC,AAAc,AAAC,gBAAC,AAAC;AACpB,gCAAI,AAAC;AACH,qJAAyC,AAAW,aAAE,AAAI,MAAC,AAAY;AACrE,AAAM,4CAAE,AAAW,YAAC,AAAI;AACxB,AAAc,oDAAE,AAAI,MAAC,AAAI,KAAC,AAAO,QAAC,AAAc,eAAE,AAAI,MAAE,AAAY,AAAC;AACrE,AAAM,4CAAE,AAAI,MAAC,AAAO;AACpB,AAAO,6CAAE,AAAW;AACpB,AAAc,oDAAE,AAAI,MAAC,AAAc,AACpC,AAAC;AANuE,iCAAnE,AAAI,AAA8B,EAMrC,AAAQ,SAAC,AAAI,MAAC,AAAI,KAAC,AAAO,QAAC,AAAc,eAAE,AAAI,AAAE,AAAmB,AAAC,AAAC,AAC3E;AAAC,8BACD,AAAK,AAAC,OAAC,AAAC,AAAC,GAAC,AAAC;AACT,AAAI,sCAAC,AAAO,QAAC,AAAK,AAAC,oEAA8D,AAAC,EAAC,AAAK,SAAI,AAAC,CAAE,AAAC;AAChG,AAAmE;AACnE,AAAc,iDAAG,AAAO,QAAC,AAAQ,aAAK,AAAO,AAC/C;AAAC,AACH;AAAC;AAED,AAAE,AAAC,4BAAC,AAAc,AAAC,gBAAC,AAAC;AACnB,wCAAW,AAAY,aAAC,AAAQ,SAAC,AAAW,YAAC,AAAI,MAAE,AAAa;AAC9D,AAAe,iDAAE,AAAI;AACrB,AAAO,yCAAE,AAAc;AACvB,AAAiB;AACjB,AAAM,wCAAE,AAAW,YAAC,AAAM,AAC3B,AAAC,AACJ;AANoE,6BAA5D,AAAI;AAMX,AACH;AAAC;AAED,AAAE,AAAC,wBAAC,AAA2B,+BAAI,AAAI,AAAC,MAAC,AAAC;AACxC,8BAAM,AAAkB,AAAE;AAC1B,AAAyC;AACzC,8BAAM,IAAI,AAAK,AAAC,qBAAe,AAAI,MAAC,AAAW,WAAC,AAAO,mDAA4C,AAA2B,2BAAE,AAAC,AACnI;AAAC,AACH;AAAC,AAAC;;;;;;AAEF,AAAI,kBAAC,AAAsB,uBAAC,AAAiB,kBAAC,AAAe,eAAE,AAAW,aAAE,AAAU,YAAE,AAAQ,AAAC;AACjG,AAAI,kBAAC,AAAc,AAAE;AACrB,AAAI,kBAAC,AAAI,AAAC,AAAiB,gDAAE,AAAI,MAAC,AAAU,AAAC;AAC7C,AAAM,mBAAC,AAAW,eAAI,AAAI,AAAC,AAAC,OAAC,CAAC,AAAe,AAAC,AAAC,AAAC,iBAAC,CAAC,AAAe,eAAE,AAAW,AAAC,AACjF;;AAAC;AAED,AAA8D;AAC9D,AAAkJ;AAClJ,AAAkE;AACpD,AAAe,mBAArB,AAAK,CAAiB,AAAsB;;;;AAClD,gBAAI,AAA4C;AAChD,gBAAI,AAAC;AACH,AAAa,gCAAG,CAAC,MAAM,AAAI,OAAC,AAAY,aAAC,AAAK,AAAC,OAAC,AAAa;AAC7D,AAAE,AAAC,oBAAC,AAAa,iBAAI,AAAI,AAAC,MAAC,AAAC;AAC1B,AAAM,2BAAC,AAAI,AACb;AAAC,AACH;AAAC,cACD,AAAK,AAAC,OAAC,AAAC,AAAC,GAAC,AAAC;AACT,AAAE,AAAC,oBAAC,AAAC,EAAC,AAAI,SAAK,AAAQ,AAAC,UAAC,AAAC;AACxB,AAAoB;AACpB,AAAM,2BAAC,AAAI,AACb;AAAC;AACD,sBAAM,AAAC,AACT;AAAC;AACD,AAAM,mBAAC,MAAM,AAAe,iHAAC,AAAK,MAAC,AAAO,QAAC,AAAa,AAAC,AAAC,AAAC,iBAAC,AAAa,AAAC,AAAC,gBAAC,CAAC,AAAa,AAAC,gBAAE,AAAc,gBAAE,AAAI,OAAC,AAAO,AAAC,AAC5H;;AAAC;AAES,AAAS,cAAC,AAAqB,eAAE,AAAiB,UAAE,AAAwB;AACpF,cAAM,AAAI,OAAG,CAAC,AAAW,AAAC;AAC1B,AAAE,AAAC,YAAC,AAAQ,AAAC,UAAC,AAAC;AACb,AAAI,iBAAC,AAAI,KAAC,AAAI,AAAC,AACjB;AAAC;AAED,AAAE,AAAC,YAAC,AAAe,AAAC,iBAAC,AAAC;AACpB,AAAI,iBAAC,AAAI,KAAC,AAAa,AAAC,AAC1B;AAAC;AAED,cAAM,AAAW,cAAG,AAAI,KAAC,AAAsB,uBAAC,AAAW;AAC3D,AAAE,AAAC,YAAC,AAAW,eAAI,AAAI,AAAC,MAAC,AAAC;AACxB,AAA2B;AAC3B,AAAI,iBAAC,AAAI,AAAC,uBAAkB,AAAW,WAAE,AAAC,AAC5C;AAAC;AAED,cAAM,AAAY;AAChB,AAAQ,sBAAE,AAAI;AACd,AAAK,mBAAE,AAAQ,AAChB;AAHoB;AAKrB,YAAI,AAAC;AACH,AAAK,iEAAC,AAAa,eAAE,AAAI,MAAE,AAAY,AAAC,cACrC,AAAK,AAAE,AACZ;AAAC,UACD,AAAK,AAAC,OAAC,AAAC,AAAC,GAAC,AAAC;AACT,AAAiD;AACjD,AAAoE;AACpE,AAAE,AAAC,gBAAE,AAAS,EAAC,AAAI,SAAK,AAAS,aAAK,AAAS,EAAC,AAAI,SAAK,AAAQ,AAAC,UAAC,AAAC;AAClE,AAAI,qBAAC,AAAO,QAAC,AAAI,KAAC,AAAoF,AAAC;AACvG,oBAAI,AAAC;AACH,AAAK,yEAAC,AAAI,MAAC,AAAI,KAAC,AAAO,QAAC,AAAc,eAAE,AAAa,AAAC,gBAAE,CAAC,AAAa,AAAC,eAAC,AAAM,OAAC,AAAI,AAAC,OAAE,AAAY,AAAC,cAChG,AAAK,AAAE,AACZ;AAAC,kBACD,AAAK,AAAC,OAAC,AAAC,AAAC,GAAC,AAAC;AACT,AAAI,yBAAC,AAAa,cAAC,AAAC,AAAC,AACvB;AAAC,AACH;AAAC,AACD,AAAI,mBAAC,AAAC;AACJ,AAAI,qBAAC,AAAa,cAAC,AAAC,AAAC,AACvB;AAAC,AACH;AAAC;AAED,AAAM,eAAC,AAAI,AACb;AAAC,AACF","sourcesContent":["import { CancellationToken, DownloadOptions, AllPublishOptions, UpdateInfo } from \"builder-util-runtime\"\nimport { BLOCK_MAP_FILE_NAME } from \"builder-util-runtime/out/blockMapApi\"\nimport { spawn } from \"child_process\"\nimport * as path from \"path\"\nimport \"source-map-support/register\"\nimport { SevenZipDifferentialDownloader } from \"./differentialDownloader/SevenZipDifferentialDownloader\"\nimport { UPDATE_DOWNLOADED } from \"./main\"\nimport { verifySignature } from \"./windowsExecutableCodeSignatureVerifier\"\nimport { BaseUpdater } from \"./BaseUpdater\"\nimport { findFile } from \"./Provider\"\n\nexport class NsisUpdater extends BaseUpdater {\n  constructor(options?: AllPublishOptions | null, app?: any) {\n    super(options, app)\n  }\n\n  /*** @private */\n  protected async doDownloadUpdate(updateInfo: UpdateInfo, cancellationToken: CancellationToken): Promise<Array<string>> {\n    const fileInfo = findFile((await this.provider).resolveFiles(updateInfo), \"exe\")!!\n    const requestHeaders = await this.computeRequestHeaders()\n    const downloadOptions: DownloadOptions = {\n      skipDirCreation: true,\n      headers: requestHeaders,\n      cancellationToken,\n      sha512: fileInfo.info.sha512,\n    }\n\n    let packagePath: string | null = this.downloadedUpdateHelper.packagePath\n\n    let installerPath = this.downloadedUpdateHelper.getDownloadedFile(updateInfo, fileInfo)\n    if (installerPath != null) {\n      return packagePath == null ? [installerPath] : [installerPath, packagePath]\n    }\n\n    await this.executeDownload(downloadOptions, fileInfo, async (tempDir, destinationFile, removeTempDirIfAny) => {\n      installerPath = destinationFile\n      let signatureVerificationStatus\n      await this.httpExecutor.download(fileInfo.url.href, installerPath, downloadOptions)\n      signatureVerificationStatus = await this.verifySignature(installerPath)\n\n      const packageInfo = fileInfo.packageInfo\n      if (packageInfo != null) {\n        packagePath = path.join(tempDir, `package-${updateInfo.version}${path.extname(packageInfo.path) || \".7z\"}`)\n\n        let isDownloadFull = packageInfo.blockMapSize == null || packageInfo.headerSize == null\n        if (!isDownloadFull) {\n          try {\n            await new SevenZipDifferentialDownloader(packageInfo, this.httpExecutor, {\n              newUrl: packageInfo.path,\n              oldPackageFile: path.join(process.resourcesPath!, \"..\", \"package.7z\"),\n              logger: this._logger,\n              newFile: packagePath,\n              requestHeaders: this.requestHeaders,\n            }).download(path.join(process.resourcesPath!, \"..\", BLOCK_MAP_FILE_NAME))\n          }\n          catch (e) {\n            this._logger.error(`Cannot download differentially, fallback to full download: ${e.stack || e}`)\n            // during test (developer machine mac or linux) we must throw error\n            isDownloadFull = process.platform === \"win32\"\n          }\n        }\n\n        if (isDownloadFull) {\n          await this.httpExecutor.download(packageInfo.path, packagePath!!, {\n            skipDirCreation: true,\n            headers: requestHeaders,\n            cancellationToken,\n            sha512: packageInfo.sha512,\n          })\n        }\n      }\n\n      if (signatureVerificationStatus != null) {\n        await removeTempDirIfAny()\n        // noinspection ThrowInsideFinallyBlockJS\n        throw new Error(`New version ${this.updateInfo!.version} is not signed by the application owner: ${signatureVerificationStatus}`)\n      }\n    })\n\n    this.downloadedUpdateHelper.setDownloadedFile(installerPath!!, packagePath, updateInfo, fileInfo)\n    this.addQuitHandler()\n    this.emit(UPDATE_DOWNLOADED, this.updateInfo)\n    return packagePath == null ? [installerPath!!] : [installerPath!!, packagePath]\n  }\n\n  // $certificateInfo = (Get-AuthenticodeSignature 'xxx\\yyy.exe'\n  // | where {$_.Status.Equals([System.Management.Automation.SignatureStatus]::Valid) -and $_.SignerCertificate.Subject.Contains(\"CN=siemens.com\")})\n  // | Out-String ; if ($certificateInfo) { exit 0 } else { exit 1 }\n  private async verifySignature(tempUpdateFile: string): Promise<string | null> {\n    let publisherName: Array<string> | string | null\n    try {\n      publisherName = (await this.configOnDisk.value).publisherName\n      if (publisherName == null) {\n        return null\n      }\n    }\n    catch (e) {\n      if (e.code === \"ENOENT\") {\n        // no app-update.yml\n        return null\n      }\n      throw e\n    }\n    return await verifySignature(Array.isArray(publisherName) ? publisherName : [publisherName], tempUpdateFile, this._logger)\n  }\n\n  protected doInstall(installerPath: string, isSilent: boolean, isForceRunAfter: boolean): boolean {\n    const args = [\"--updated\"]\n    if (isSilent) {\n      args.push(\"/S\")\n    }\n\n    if (isForceRunAfter) {\n      args.push(\"--force-run\")\n    }\n\n    const packagePath = this.downloadedUpdateHelper.packagePath\n    if (packagePath != null) {\n      // only = form is supported\n      args.push(`--package-file=${packagePath}`)\n    }\n\n    const spawnOptions = {\n      detached: true,\n      stdio: \"ignore\",\n    }\n\n    try {\n      spawn(installerPath, args, spawnOptions)\n        .unref()\n    }\n    catch (e) {\n      // yes, such errors dispatched not as error event\n      // https://github.com/electron-userland/electron-builder/issues/1129\n      if ((e as any).code === \"UNKNOWN\" || (e as any).code === \"EACCES\") { // Node 8 sends errors: https://nodejs.org/dist/latest-v8.x/docs/api/errors.html#errors_common_system_errors\n        this._logger.info(\"Access denied or UNKNOWN error code on spawn, will be executed again using elevate\")\n        try {\n          spawn(path.join(process.resourcesPath!, \"elevate.exe\"), [installerPath].concat(args), spawnOptions)\n            .unref()\n        }\n        catch (e) {\n          this.dispatchError(e)\n        }\n      }\n      else {\n        this.dispatchError(e)\n      }\n    }\n\n    return true\n  }\n}"]}
